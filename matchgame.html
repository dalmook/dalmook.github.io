<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê·¸ë¦¼ ì§ë§ì¶”ê¸° ê²Œì„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background-color: #f0f8ff;
            margin: 0;
            padding: 0;
        }
        h1 {
            margin: 20px 0;
            color: #333;
            font-size: 2em;
        }
        /* ê³µí†µ ìŠ¤íƒ€ì¼ */
        #controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px 0;
            padding: 0 10px;
        }
        #controls > * {
            margin: 5px 0;
            width: 100%;
            max-width: 300px;
        }
        select, button, input {
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            background-color: #ffa500;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #ff8c00;
        }
        #score {
            font-size: 1.2em;
            margin: 10px 0;
            transition: color 0.5s;
        }
        /* ê·¸ë¦¼ ì§ë§ì¶”ê¸° ê²Œì„ ìŠ¤íƒ€ì¼ */
        #wordDisplay {
            margin: 10px 0;
            font-size: 1.5em;
            color: #333;
            height: 1.5em;
            transition: transform 0.3s ease, color 0.3s ease;
        }
        #wordDisplay.grow {
            transform: scale(1.5);
        }
        #gameBoard {
            display: grid;
            gap: 10px;
            justify-content: center;
            padding: 10px;
            max-width: 100%;
            margin: 0 auto 20px;
        }
        .game-board.easy {
            grid-template-columns: repeat(4, 1fr);
        }
        .game-board.medium {
            grid-template-columns: repeat(6, 1fr);
        }
        .game-board.hard {
            grid-template-columns: repeat(8, 1fr);
        }
        .card {
            width: 100%;
            padding-bottom: 100%; /* ì •ì‚¬ê°í˜• ìœ ì§€ */
            position: relative;
            background-color: #333;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.3s, background-color 0.3s;
            background-size: cover;
            background-position: center;
        }

        .card.flip {
            transform: rotateY(180deg);
        }

        .card-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            color: white;
            background-color: rgba(0,0,0,0.6);
            border-radius: 10px;
        }

        /* ê²Œì„ ë³´ë“œ ë ˆì´ì•„ì›ƒ */
        .game-board {
            display: grid;
            gap: 10px; /* ì¹´ë“œ ê°„ì˜ ê°„ê²© */
            margin-top: 20px;
        }

        .game-board.easy {
            grid-template-columns: repeat(4, 1fr); /* ì‰¬ì›€: 4ì—´ */
        }

        .game-board.medium {
            grid-template-columns: repeat(6, 1fr); /* ë³´í†µ: 6ì—´ */
        }

        .game-board.hard {
            grid-template-columns: repeat(8, 1fr); /* ì–´ë ¤ì›€: 8ì—´ */
        }

        /* ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        #countdownOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #countdownNumber {
            font-size: 5em;
            color: white;
            animation: fade 1s infinite;
        }

        @keyframes fade {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* ì„±ê³µ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        #successMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
            text-align: center;
            z-index: 2000;
        }

        #successMessage img {
            width: 100px;
            height: 100px;
        }

        #successMessage button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1em;
            border: none;
            background-color: #28a745;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        #successMessage button:hover {
            background-color: #218838;
        }

        /* ê¸°ë¡ ì„¹ì…˜ ìŠ¤íƒ€ì¼ (ëª¨ë‹¬) */
        #recordSection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #recordContent {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s ease-out;
        }

        /* ê¸°ë¡ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        #recordTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #recordTable th, #recordTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        #recordTable th {
            background-color: #f2f2f2;
        }

        /* ê¸°ë¡ ë³´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #viewRecordsButton {
            font-size: 0.8em;
            padding: 5px 10px;
            border: 1px solid #ccc;
            background-color: #ffa500;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        #viewRecordsButton:hover {
            background-color: #ff8c00;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
    
    <!-- Firebase SDK ì¶”ê°€ -->
    <!-- Firebase App (í•„ìˆ˜) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>
        ê·¸ë¦¼ ì§ë§ì¶”ê¸° ê²Œì„
        <button id="viewRecordsButton">ê¸°ë¡ ë³´ê¸°</button>
    </h1>
    <!-- ê²Œì„ ì‹œì‘ ì„¹ì…˜ -->
    <div id="controls">
        <select id="category">
            <option value="animals">ë™ë¬¼</option>
            <option value="plants">ì‹ë¬¼</option>
            <option value="tyniping">í‹°ë‹ˆí•‘</option>
            <option value="hangul">í•œê¸€</option>
            <!-- í•„ìš”í•œ ê²½ìš° ë” ì¶”ê°€ -->
        </select>
        <select id="difficulty">
            <option value="easy">ì‰¬ì›€ (4ì—´ x 4í–‰, 16ì¹¸)</option>
            <option value="medium">ë³´í†µ (6ì—´ x 6í–‰, 36ì¹¸)</option>
            <option value="hard">ì–´ë ¤ì›€ (8ì—´ x 8í–‰, 64ì¹¸)</option>
        </select>
        <button id="startMatchingGame">ê²Œì„ ì‹œì‘</button>
    </div>
    <div id="score">ì ìˆ˜: 0</div>
    <div id="wordDisplay"></div>
    <div class="game-board easy" id="gameBoard">
        <!-- ì¹´ë“œê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>

    <!-- ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ -->
    <div id="countdownOverlay">
        <div id="countdownNumber">3</div>
    </div>

    <!-- ì„±ê³µ ë©”ì‹œì§€ -->
    <div id="successMessage">
        <img src="https://i.imgur.com/4AI6B5K.png" alt="ì¶•í•˜ ì´ë¯¸ì§€">
        <div>ì¶•í•˜í•´ìš”! ëª¨ë“  ì§ì„ ë§ì·„ì–´ìš”!</div>
        <button id="restartButton">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>

    <!-- ê¸°ë¡ ì„¹ì…˜ (ëª¨ë‹¬) -->
    <div id="recordSection">
        <div id="recordContent">
            <h2>ğŸ‰ í´ë¦¬ì–´ ê¸°ë¡ ì €ì¥ ğŸ‰</h2>
            <label for="playerName">ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:</label>
            <input type="text" id="playerName" placeholder="ì´ë¦„">
            <button id="saveRecordButton">ì €ì¥</button>
            <h3>ê¸°ë¡ ë³´ê¸°</h3>
            <table id="recordTable">
                <thead>
                    <tr>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th>ë‚œì´ë„</th>
                        <th>ì´ë¦„</th>
                        <th>ì ìˆ˜</th>
                        <th>ë‚ ì§œ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- ê¸°ë¡ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </tbody>
            </table>
            <button id="backToGameButton">ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <!-- ì˜¤ë””ì˜¤ ìš”ì†Œ -->
    <audio id="correctSoundEffect" src="https://www.soundjay.com/buttons/sounds/button-16.mp3" preload="auto"></audio> <!-- "ëµë™" ì†Œë¦¬ -->
    <audio id="incorrectSound" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>

    <script>
        // Firebase ì´ˆê¸°í™” (Firebase ì½˜ì†”ì—ì„œ ì–»ì€ ì„¤ì • ì •ë³´ë¡œ ëŒ€ì²´)
        const firebaseConfig = {
            apiKey: "AIzaSyCyl4P_GntdnYHMxwzPNfCQn1dBJkUCEwI",
            authDomain: "dalbongwebserver.firebaseapp.com",
            projectId: "dalbongwebserver",
            storageBucket: "dalbongwebserver.firebasestorage.app",
            messagingSenderId: "868740633776",
            appId: "1:868740633776:web:0a4d8438f385ce6e425775"
        };
        
        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ì¹´í…Œê³ ë¦¬ ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let categories = {};

        // ë³€ìˆ˜ ì´ˆê¸°í™”
        let selectedCategory = 'animals';
        let pairsCount = 8; // ì‰¬ì›€: 4x4 (16ì¹¸, 8ìŒ), ë³´í†µ: 6x6 (36ì¹¸, 18ìŒ), ì–´ë ¤ì›€: 8x8 (64ì¹¸, 32ìŒ)
        let gameImages = [];
        let firstCard = null;
        let secondCard = null;
        let score = 0;
        let matchedPairs = 0;
        let isProcessing = false;

        const matchingStartButton = document.getElementById('startMatchingGame');
        const categorySelectMatching = document.getElementById('category');
        const difficultySelect = document.getElementById('difficulty');
        const gameBoard = document.getElementById('gameBoard');
        const scoreDisplay = document.getElementById('score');
        const wordDisplay = document.getElementById('wordDisplay');

        const successMessage = document.getElementById('successMessage');
        const restartButton = document.getElementById('restartButton');

        const recordSection = document.getElementById('recordSection');
        const saveRecordButton = document.getElementById('saveRecordButton');
        const backToGameButton = document.getElementById('backToGameButton');
        const recordTableBody = document.getElementById('recordTable').querySelector('tbody');

        const countdownOverlay = document.getElementById('countdownOverlay');
        const countdownNumber = document.getElementById('countdownNumber');

        const viewRecordsButton = document.getElementById('viewRecordsButton');

        // ê²Œì„ ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸ (ê·¸ë¦¼ ì§ë§ì¶”ê¸°)
        matchingStartButton.addEventListener('click', () => {
            startMatchingGame(); // ê²Œì„ ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œ
        });

        // ê¸°ë¡ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        viewRecordsButton.addEventListener('click', () => {
            recordSection.style.display = 'flex'; // ê¸°ë¡ ì„¹ì…˜ ì—´ê¸°
        });

        // ìƒˆë¡œìš´ ê²Œì„ ì‹œì‘ í•¨ìˆ˜
        function startMatchingGame() {
            // ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            countdownOverlay.style.display = 'flex';
            countdownNumber.textContent = '3';
            
            let countdown = 3;
            isProcessing = true; // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì¼ì‹œ ë¹„í™œì„±í™”
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownNumber.textContent = countdown;
                    // ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘
                    countdownNumber.classList.remove('fade');
                    void countdownNumber.offsetWidth; // ë¦¬í”Œë¡œìš°ë¥¼ ê°•ì œí•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘
                    countdownNumber.classList.add('fade');
                } else {
                    clearInterval(countdownInterval);
                    countdownOverlay.style.display = 'none';
                    initializeMatchingGame();
                }
            }, 1000);
            
            // ì¹´ìš´íŠ¸ë‹¤ìš´ ë™ì•ˆ ì´ë¯¸ì§€ì™€ ìŒì„± ë¯¸ë¦¬ ë¡œë“œ
            preloadResources();
        }

        // ë¦¬ì†ŒìŠ¤ ë¯¸ë¦¬ ë¡œë“œ í•¨ìˆ˜
        function preloadResources() {
            const categoryItems = categories[selectedCategory];
            if (!categoryItems || categoryItems.length < pairsCount) return;
            
            // ì§ì˜ ìˆ˜ì— ë§ê²Œ ì•„ì´í…œ ì„ íƒ
            const shuffled = shuffleArray([...categoryItems]);
            const selectedItems = shuffled.slice(0, pairsCount);
            const imagesToLoad = [...selectedItems, ...selectedItems].map(item => item.image);
            
            imagesToLoad.forEach(src => {
                const img = new Image();
                img.src = src;
            });
            
            // í‹°ë‹ˆí•‘ ì¹´í…Œê³ ë¦¬ì˜ ì†Œë¦¬ ë¯¸ë¦¬ ë¡œë“œ (sound ì†ì„±ì´ ìˆë‹¤ë©´)
            if (selectedCategory === 'tyniping') {
                categories.tyniping.forEach(char => {
                    if (char.sound) {
                        const audio = new Audio(char.sound);
                        audio.load();
                    }
                });
            }
        }

        // ê²Œì„ ì´ˆê¸°í™” í•¨ìˆ˜ (ìˆ˜ì •ë¨)
        function initializeMatchingGame() {
            // ë‚œì´ë„ì— ë”°ë¥¸ ì •ë‹µ ë…¸ì¶œ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
            let revealTime = 1500; // ê¸°ë³¸ê°’ (ì‰¬ì›€)
            const currentDifficulty = difficultySelect.value;
            switch (currentDifficulty) {
                case 'easy':
                    revealTime = 1500; // 1.5ì´ˆ
                    break;
                case 'medium':
                    revealTime = 2000; // 2ì´ˆ
                    break;
                case 'hard':
                    revealTime = 3000; // 3ì´ˆ
                    break;
                default:
                    revealTime = 1500; // ê¸°ë³¸ê°’
            }

            // ê¸°ì¡´ ì´ˆê¸°í™” ë¡œì§
            selectedCategory = categorySelectMatching.value;
            gameBoard.classList.remove('easy', 'medium', 'hard');
            switch (currentDifficulty) {
                case 'easy':
                    pairsCount = 8; 
                    gameBoard.classList.add('easy');
                    break;
                case 'medium':
                    pairsCount = 18; 
                    gameBoard.classList.add('medium');
                    break;
                case 'hard':
                    pairsCount = 32; 
                    gameBoard.classList.add('hard');
                    break;
                default:
                    pairsCount = 8;
                    gameBoard.classList.add('easy');
            }

            const categoryItems = categories[selectedCategory];
            if (!categoryItems || categoryItems.length < pairsCount) {
                alert('ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì— ì¶©ë¶„í•œ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const shuffled = shuffleArray([...categoryItems]);
            const selectedItems = shuffled.slice(0, pairsCount);
            gameImages = [...selectedItems, ...selectedItems];
            gameImages = shuffleArray(gameImages);

            gameBoard.innerHTML = '';

            // ì´ë¯¸ì§€ ë¡œë“œ í™•ì¸
            let loadedImagesCount = 0;
            const totalImages = gameImages.length;

            gameImages.forEach((item, index) => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.dataset.image = item.image;
                card.dataset.name = item.name;

                // ì¹´ë“œ ë’·ë©´ ì„¤ì •
                const img = new Image();
                img.src = item.image;
                img.onload = () => {
                    loadedImagesCount++;
                    if (loadedImagesCount === totalImages) {
                        // ëª¨ë“  ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ í›„ ê²Œì„ ì‹œì‘
                        startGame(revealTime);
                    }
                };

                card.style.backgroundImage = `url("${item.image}")`; // ì •ë‹µ í‘œì‹œ
                card.style.backgroundSize = 'cover';
                card.style.backgroundPosition = 'center';

                const cardContent = document.createElement('div');
                cardContent.classList.add('card-content');
                cardContent.innerHTML = 'â“'; // ìˆ¨ê¸¸ ë•Œ ë‚˜íƒ€ë‚¼ ë‚´ìš©
                card.appendChild(cardContent);
                gameBoard.appendChild(card);
            });

            // ì ìˆ˜ ë° ìƒíƒœ ì´ˆê¸°í™”
            score = 0;
            matchedPairs = 0;
            scoreDisplay.textContent = `ì ìˆ˜: ${score}`;
            wordDisplay.textContent = '';
            recordSection.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // ìƒˆë¡œìš´ ê²Œì„ ì‹œì‘ í•¨ìˆ˜ (ì¶”ê°€ë¨)
        function startGame(revealTime) {
            // ëª¨ë“  ì¹´ë“œë¥¼ ì•ë©´ìœ¼ë¡œ í‘œì‹œ
            gameBoard.querySelectorAll('.card').forEach(card => {
                card.style.backgroundImage = `url("${card.dataset.image}")`;
                card.querySelector('.card-content').style.display = 'none'; // â“ ìˆ¨ê¹€
            });

            // ì •í•´ì§„ ì‹œê°„ í›„ì— ëª¨ë“  ì¹´ë“œë¥¼ ë’·ë©´ìœ¼ë¡œ ìˆ¨ê¹€
            setTimeout(() => {
                gameBoard.querySelectorAll('.card').forEach(card => {
                    card.style.backgroundImage = 'url("https://cdn-icons-png.flaticon.com/512/929/929500.png")'; // ì¹´ë“œ ë’·ë©´
                    card.querySelector('.card-content').style.display = 'flex'; // â“ í‘œì‹œ
                });
                isProcessing = false; // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ê°€ëŠ¥
            }, revealTime);
        }

        // ê·¸ë¦¼ ì§ë§ì¶”ê¸° ê²Œì„ ì¹´ë“œ ë’¤ì§‘ê¸° í•¨ìˆ˜
        function flipCard() {
            if (isProcessing || this.classList.contains('matched') || this === firstCard) return;
            this.classList.add('flip');
            this.style.backgroundImage = `url("${this.dataset.image}")`;
            const cardContent = this.querySelector('.card-content');
            cardContent.style.display = 'none';

            // í´ë¦­í•œ ì¹´ë“œì˜ ë‹¨ì–´ì™€ ì„¤ëª…ì„ ì½ì–´ì¤ë‹ˆë‹¤. í˜„ì¬ ì¹´í…Œê³ ë¦¬ë¥¼ í•¨ê»˜ ì „ë‹¬
            speakWord(this.dataset.name, selectedCategory);

            // í´ë¦­í•œ ì¹´ë“œì˜ ì´ë¦„ê³¼ ì„¤ëª…ì„ ì ìˆ˜ ì•„ë˜ì— í‘œì‹œ
            if (this.dataset.desc) {
                displayWord(`${this.dataset.name} (${this.dataset.desc})`);
            } else {
                displayWord(`${this.dataset.name}`);
            }

            if (!firstCard) {
                firstCard = this;
            } else {
                secondCard = this;
                isProcessing = true;
                checkMatch();
            }
        }

        // ë§¤ì¹˜ í™•ì¸ í•¨ìˆ˜
        function checkMatch() {
            if (firstCard.dataset.image === secondCard.dataset.image) {
                // ë§¤ì¹˜ëœ ê²½ìš°
                firstCard.classList.add('matched');
                secondCard.classList.add('matched');
                matchedPairs++;
                updateScore(10); // ì ìˆ˜ +10
                
                // ì¹´í…Œê³ ë¦¬ê°€ 'tyniping'ì¸ ê²½ìš° ìºë¦­í„°ë³„ íš¨ê³¼ìŒ ì¬ìƒ (sound ì†ì„±ì´ ìˆë‹¤ë©´)
                if (selectedCategory === 'tyniping') {
                    const characterSound = categories.tyniping.find(char => char.name === firstCard.dataset.name)?.sound;
                    if (characterSound) {
                        playCharacterSound(characterSound);
                    }
                }

                resetCards();

                // ëª¨ë“  ì§ì„ ë§ì·„ëŠ”ì§€ í™•ì¸
                if (matchedPairs === pairsCount) {
                    setTimeout(() => {
                        playCorrectSoundEffect();
                        showRecordSection();
                    }, 500);
                }
            } else {
                // ë§¤ì¹˜ë˜ì§€ ì•Šì€ ê²½ìš°
                setTimeout(() => {
                    firstCard.classList.remove('flip');
                    secondCard.classList.remove('flip');
                    firstCard.style.backgroundImage = 'url("https://cdn-icons-png.flaticon.com/512/929/929500.png")';
                    secondCard.style.backgroundImage = 'url("https://cdn-icons-png.flaticon.com/512/929/929500.png")';
                    const firstContent = firstCard.querySelector('.card-content');
                    const secondContent = secondCard.querySelector('.card-content');
                    firstContent.style.display = 'flex';
                    secondContent.style.display = 'flex';
                    updateScore(-2); // ì ìˆ˜ -2
                    resetCards();
                }, 1000);
            }
        }

        // ì ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateScore(delta) {
            // ì ìˆ˜ ì—…ë°ì´íŠ¸
            score += delta;
            scoreDisplay.textContent = `ì ìˆ˜: ${score}`;

            // ê¹œë¹¡ì´ëŠ” íš¨ê³¼
            const originalColor = scoreDisplay.style.color || '#000';
            if (delta < 0) {
                scoreDisplay.style.color = 'red'; // ê¹œë¹¡ì´ëŠ” ìƒ‰ìƒ: ë¹¨ê°„ìƒ‰
            } else {
                scoreDisplay.style.color = 'blue'; // ê¹œë¹¡ì´ëŠ” ìƒ‰ìƒ: íŒŒë€ìƒ‰
            }

            // 0.5ì´ˆ í›„ ì›ë˜ ìƒ‰ìƒìœ¼ë¡œ ë³µì›
            setTimeout(() => {
                scoreDisplay.style.color = originalColor;
            }, 500);
        }

        // ì¹´ë“œ ìƒíƒœ ì´ˆê¸°í™”
        function resetCards() {
            firstCard = null;
            secondCard = null;
            isProcessing = false;
        }

        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ ë° ê¸°ë¡ ì„¹ì…˜ ì—´ê¸°
        function showRecordSection() {
            recordSection.style.display = 'flex'; // ëª¨ë‹¬ í‘œì‹œ
        }

        // ê¸°ë¡ ì €ì¥ í•¨ìˆ˜ (Firestoreì— ì €ì¥)
        function saveRecord(record) {
            return db.collection('gameRecords').add(record)
                .then(() => {
                    console.log('ê²Œì„ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                })
                .catch((error) => {
                    console.error('ê²Œì„ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ', error);
                    throw error; // ì—ëŸ¬ë¥¼ ìƒìœ„ë¡œ ì „ë‹¬
                });
        }

        // ê¸°ë¡ ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
        saveRecordButton.addEventListener('click', () => {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
                return;
            }

            // ê¸°ë¡ ìƒì„±
            const newRecord = {
                category: selectedCategory,
                difficulty: difficultySelect.value,
                name: playerName,
                score: score,
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // ê¸°ë¡ ì‹œê°„
            };

            // Firestoreì— ê¸°ë¡ ì €ì¥
            saveRecord(newRecord).then(() => {
                // ì´ë¦„ ì…ë ¥ í•„ë“œ ìˆ¨ê¸°ê³  ê¸°ë¡ í…Œì´ë¸” í‘œì‹œ
                document.getElementById('playerName').style.display = 'none';
                saveRecordButton.style.display = 'none';
            }).catch((error) => {
                console.error('ê²Œì„ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ', error);
                alert('ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            });
        });

        // ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        backToGameButton.addEventListener('click', () => {
            recordSection.style.display = 'none';
            // ì´ë¦„ ì…ë ¥ í•„ë“œì™€ ì €ì¥ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê²Œ ì„¤ì •
            document.getElementById('playerName').style.display = 'block';
            saveRecordButton.style.display = 'block';
            // ê²Œì„ ì´ˆê¸°í™”
            startMatchingGame(); // ìƒˆ ê²Œì„ ì‹œì‘
        });

        // Firestoreì—ì„œ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadRecordsFromFirestore() {
            db.collection('gameRecords').orderBy('score', 'desc').onSnapshot((snapshot) => { // ì ìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const record = change.doc.data();
                        addRecordToTable(record);
                    }
                });
            });
        }

        // ê¸°ë¡ í…Œì´ë¸”ì— ê¸°ë¡ ì¶”ê°€ í•¨ìˆ˜
        function addRecordToTable(record) {
            const recordTableBody = document.getElementById('recordTable').querySelector('tbody');
            const row = document.createElement('tr');
            const date = record.timestamp ? record.timestamp.toDate().toLocaleString() : 'N/A';
            row.innerHTML = `
                <td>${record.category}</td>
                <td>${record.difficulty}</td>
                <td>${record.name}</td>
                <td>${record.score}</td>
                <td>${date}</td>
            `;
            recordTableBody.appendChild(row);

            // í…Œì´ë¸” ëìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
            recordTableBody.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Firestore ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = async function() {
            await loadCategories(); // categories.json ë¶ˆëŸ¬ì˜¤ê¸°
            loadRecordsFromFirestore();
            // initializeMatchingGame(); // ì´ ì¤„ì„ ì œê±°í•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”.
        };

        // ì˜ì–´ ë‹¨ì–´ í‘œì‹œ í•¨ìˆ˜
        function displayWord(word) {
            wordDisplay.textContent = word;

            // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ ì¶”ê°€
            wordDisplay.classList.add('grow');
            setTimeout(() => {
                wordDisplay.classList.remove('grow');
            }, 300); // 0.3ì´ˆ í›„ ì›ë˜ í¬ê¸°ë¡œ ë³µì›
        }

        // ë‹¨ì–´ ì†Œë¦¬ ë‚´ì–´ ì½ê¸° í•¨ìˆ˜
        function speakWord(word, category) {
            const utterance = new SpeechSynthesisUtterance(word);
            
            // ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ ì–¸ì–´ ì„¤ì •
            if (category === 'tyniping') {
                utterance.lang = 'ko-KR'; // í•œêµ­ì–´
            } else {
                utterance.lang = 'en-US'; // ì˜ì–´
            }
            
            // ìŒì„± ì„¤ì • í•¨ìˆ˜
            function setVoice() {
                const voices = window.speechSynthesis.getVoices();
                const selectedVoice = voices.find(voice => voice.lang === utterance.lang);
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }
                window.speechSynthesis.speak(utterance);
            }

            // ìŒì„± ëª©ë¡ì´ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°
            if (speechSynthesis.getVoices().length !== 0) {
                setVoice();
            } else {
                // ìŒì„± ëª©ë¡ì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                speechSynthesis.onvoiceschanged = setVoice;
            }
        }

        // ë°°ì—´ ì„ê¸° í•¨ìˆ˜ (Fisher-Yates Shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // íŠ¹ì • íš¨ê³¼ìŒ ì¬ìƒ í•¨ìˆ˜
        function playCharacterSound(url) {
            const audio = new Audio(url);
            audio.play();
        }
        
        // ì§ì´ ìµœì¢… ë§ì•˜ì„ ë•Œ ì†Œë¦¬ ì¬ìƒ í•¨ìˆ˜
        function playCorrectSoundEffect() {
            const correctSoundEffect = document.getElementById('correctSoundEffect');
            correctSoundEffect.currentTime = 0;
            correctSoundEffect.play();
        }
        
        // ê²Œì„ ì¬ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸
        restartButton.addEventListener('click', () => {
            restartGame();
        });

        // ê²Œì„ ì¬ì‹œì‘ í•¨ìˆ˜
        function restartGame() {
            startMatchingGame();
            successMessage.style.display = 'none';
        }

        // categories.json ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
        async function loadCategories() {
            try {
                const response = await fetch('categories.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                categories = await response.json();
                console.log('Categories loaded:', categories);
            } catch (error) {
                console.error('Failed to load categories:', error);
                alert('ì¹´í…Œê³ ë¦¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¨ì–´ ì—°ê²° ê²Œì„</title>
    <link rel="stylesheet" href="piecestyles.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>ë‹¨ì–´ ì—°ê²° ê²Œì„
        <button id="viewRecordsButton">ê¸°ë¡ ë³´ê¸°</button>
    </h1>
    <p>ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>
    <select id="difficulty">
        <option value="easy">Easy (5x5, 5ë‹¨ì–´)</option>
        <option value="medium">Medium (7x7, 7ë‹¨ì–´)</option>
        <option value="hard">Hard (9x9, 9ë‹¨ì–´)</option>
    </select>
    <button id="start-game">ê²Œì„ ì‹œì‘</button>
    <div class="game-container">
        <div id="grid" class="grid"></div>
        <div id="word-list" class="word-list">
            <h2>ì°¾ì„ ë‹¨ì–´</h2>
            <ul id="words-to-find"></ul>
        </div>
    <!-- ê¸°ë¡ ì„¹ì…˜ (ëª¨ë‹¬) -->
    <div id="recordSection">
        <div id="recordContent">
            <h2>ğŸ‰ í´ë¦¬ì–´ ê¸°ë¡ ì €ì¥ ğŸ‰</h2>
            <label for="playerName">ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:</label>
            <input type="text" id="playerName" placeholder="ì´ë¦„">
            <button id="saveRecordButton">ì €ì¥</button>
            <h3>ê¸°ë¡ ë³´ê¸°</h3>
            <table id="recordTable">
                <thead>
                    <tr>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th>ë‚œì´ë„</th>
                        <th>ì´ë¦„</th>
                        <th>ì ìˆ˜</th>
                        <th>ë‚ ì§œ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- ê¸°ë¡ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </tbody>
            </table>
            <button id="backToGameButton">ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <script>
        // Firebase ì´ˆê¸°í™” (Firebase ì½˜ì†”ì—ì„œ ì–»ì€ ì„¤ì • ì •ë³´ë¡œ ëŒ€ì²´)
        const firebaseConfig = {
            apiKey: "AIzaSyBeCVOghDQw8hPdp0JrHovXcU7d7aKmmFE",
            authDomain: "piecechoice.firebaseapp.com",
            projectId: "piecechoice",
            storageBucket: "piecechoice.firebasestorage.app",
            messagingSenderId: "1048561191876",
            appId: "1:1048561191876:web:43e94b515fd260aceb7291"
        };
        
        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const scoreDisplay = document.getElementById('score');

        const restartButton = document.getElementById('restartButton');

        const recordSection = document.getElementById('recordSection');
        const saveRecordButton = document.getElementById('saveRecordButton');
        const backToGameButton = document.getElementById('backToGameButton');
        const recordTableBody = document.getElementById('recordTable').querySelector('tbody');

        const viewRecordsButton = document.getElementById('viewRecordsButton');

        // ê¸°ë¡ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        viewRecordsButton.addEventListener('click', () => {
            recordSection.style.display = 'flex'; // ê¸°ë¡ ì„¹ì…˜ ì—´ê¸°
        });

        // ìƒˆë¡œìš´ ê²Œì„ ì‹œì‘ í•¨ìˆ˜
        function startMatchingGame() {
            // ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            countdownOverlay.style.display = 'flex';
            countdownNumber.textContent = '2';
            
            let countdown = 2;
            isProcessing = true; // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì¼ì‹œ ë¹„í™œì„±í™”
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownNumber.textContent = countdown;
                    // ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘
                    countdownNumber.classList.remove('fade');
                    void countdownNumber.offsetWidth; // ë¦¬í”Œë¡œìš°ë¥¼ ê°•ì œí•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘
                    countdownNumber.classList.add('fade');
                } else {
                    clearInterval(countdownInterval);
                    countdownOverlay.style.display = 'none';
                    initializeMatchingGame();
                }
            }, 1000);
            
            // ì¹´ìš´íŠ¸ë‹¤ìš´ ë™ì•ˆ ì´ë¯¸ì§€ì™€ ìŒì„± ë¯¸ë¦¬ ë¡œë“œ
            preloadResources();
        }


        // ê¸°ë¡ ì €ì¥ í•¨ìˆ˜ (Firestoreì— ì €ì¥)
        function saveRecord(record) {
            return db.collection('gameRecords').add(record)
                .then(() => {
                    console.log('ê²Œì„ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                })
                .catch((error) => {
                    console.error('ê²Œì„ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ', error);
                    throw error; // ì—ëŸ¬ë¥¼ ìƒìœ„ë¡œ ì „ë‹¬
                });
        }

        // ê¸°ë¡ ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
        saveRecordButton.addEventListener('click', () => {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
                return;
            }

            // ê¸°ë¡ ìƒì„±
            const newRecord = {
                category: selectedCategory,
                difficulty: difficultySelect.value,
                name: playerName,
                score: score,
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // ê¸°ë¡ ì‹œê°„
            };

            // Firestoreì— ê¸°ë¡ ì €ì¥
            saveRecord(newRecord).then(() => {
                // ì´ë¦„ ì…ë ¥ í•„ë“œ ìˆ¨ê¸°ê³  ê¸°ë¡ í…Œì´ë¸” í‘œì‹œ
                document.getElementById('playerName').style.display = 'none';
                saveRecordButton.style.display = 'none';
            }).catch((error) => {
                console.error('ê²Œì„ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ', error);
                alert('ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            });
        });

        // ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        backToGameButton.addEventListener('click', () => {
            recordSection.style.display = 'none';
            // ì´ë¦„ ì…ë ¥ í•„ë“œì™€ ì €ì¥ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê²Œ ì„¤ì •
            document.getElementById('playerName').style.display = 'block';
            saveRecordButton.style.display = 'block';
            // ê²Œì„ ì´ˆê¸°í™”
            startMatchingGame(); // ìƒˆ ê²Œì„ ì‹œì‘
        });

        // Firestoreì—ì„œ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadRecordsFromFirestore() {
            db.collection('gameRecords').orderBy('score', 'desc').onSnapshot((snapshot) => { // ì ìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const record = change.doc.data();
                        addRecordToTable(record);
                    }
                });
            });
        }

        // ê¸°ë¡ í…Œì´ë¸”ì— ê¸°ë¡ ì¶”ê°€ í•¨ìˆ˜
        function addRecordToTable(record) {
            const recordTableBody = document.getElementById('recordTable').querySelector('tbody');
            const row = document.createElement('tr');
            const date = record.timestamp ? record.timestamp.toDate().toLocaleString() : 'N/A';
            row.innerHTML = `
                <td>${record.category}</td>
                <td>${record.difficulty}</td>
                <td>${record.name}</td>
                <td>${record.score}</td>
                <td>${date}</td>
            `;
            recordTableBody.appendChild(row);

            // í…Œì´ë¸” ëìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
            recordTableBody.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Firestore ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = async function() {
            await loadCategories(); // categories.json ë¶ˆëŸ¬ì˜¤ê¸°
            loadRecordsFromFirestore();
            // initializeMatchingGame(); // ì´ ì¤„ì„ ì œê±°í•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”.
        };

    
        // ê²Œì„ ì¬ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸
        restartButton.addEventListener('click', () => {
            restartGame();
        });

        // ê²Œì„ ì¬ì‹œì‘ í•¨ìˆ˜
        function restartGame() {
            startMatchingGame();
            successMessage.style.display = 'none';
        }

    </script>
    </div>
    <p id="timer">ê±¸ë¦° ì‹œê°„: 0ì´ˆ</p>
    <p id="result"></p>
    <script src="piecescript.js"></script>
</body>
</html>

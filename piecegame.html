<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¨ì–´ ì—°ê²° ê²Œì„</title>
    <link rel="stylesheet" href="piecestyles.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>ë‹¨ì–´ ì—°ê²° ê²Œì„
        <button id="viewRecordsButton">ê¸°ë¡ ë³´ê¸°</button>
    </h1>
    <p>ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>
    <select id="difficulty">
        <option value="easy">Easy (5x5, 5ë‹¨ì–´)</option>
        <option value="medium">Medium (7x7, 7ë‹¨ì–´)</option>
        <option value="hard">Hard (9x9, 9ë‹¨ì–´)</option>
    </select>
    <button id="start-game">ê²Œì„ ì‹œì‘</button>
    <div class="game-container">
        <div id="grid" class="grid"></div>
        <div id="word-list" class="word-list">
            <h2>ì°¾ì„ ë‹¨ì–´</h2>
            <ul id="words-to-find"></ul>
        </div>
    <!-- ê¸°ë¡ ì„¹ì…˜ (ëª¨ë‹¬) -->
    <div id="recordSection">
        <div id="recordContent">
            <h2>ğŸ‰ í´ë¦¬ì–´ ê¸°ë¡ ì €ì¥ ğŸ‰</h2>
            <label for="playerName">ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:</label>
            <input type="text" id="playerName" placeholder="ì´ë¦„">
            <button id="saveRecordButton">ì €ì¥</button>
            <h3>ê¸°ë¡ ë³´ê¸°</h3>
            <table id="recordTable">
                <thead>
                    <tr>
                        <th>ë‚œì´ë„</th>
                        <th>ì´ë¦„</th>
                        <th>ì ìˆ˜</th>
                        <th>ë‚ ì§œ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- ê¸°ë¡ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </tbody>
            </table>
            <button id="backToGameButton">ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>
    </div>
    <p id="score">ê±¸ë¦° ì‹œê°„: 0ì´ˆ</p>
    <p id="result"></p>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBeCVOghDQw8hPdp0JrHovXcU7d7aKmmFE",
            authDomain: "piecechoice.firebaseapp.com",
            projectId: "piecechoice",
            storageBucket: "piecechoice.firebasestorage.app",
            messagingSenderId: "1048561191876",
            appId: "1:1048561191876:web:43e94b515fd260aceb7291"
        };
        
            // Firebase ì´ˆê¸°í™”
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
        
        const grid = document.getElementById("grid");
        const wordList = document.getElementById("words-to-find");
        const result = document.getElementById("result");
        const startButton = document.getElementById("start-game");
        const timerDisplay = document.getElementById("timer");
        
        const matchingStartButton = document.getElementById('startMatchingGame');
        const difficultySelect = document.getElementById('difficulty');
        const gameBoard = document.getElementById('gameBoard');
        const scoreDisplay = document.getElementById('score');
        const wordDisplay = document.getElementById('wordDisplay');
        const recordSection = document.getElementById('recordSection');
        const saveRecordButton = document.getElementById('saveRecordButton');
        const playerNameInput = document.getElementById('playerName');
        const backToGameButton = document.getElementById('backToGameButton');
        const recordTableBody = document.getElementById('recordTable').querySelector('tbody');
        const viewRecordsButton = document.getElementById('viewRecordsButton');
        
        let wordsToFind = [];
        let gridWords = [];
        let gridSize = 5; // ê¸°ë³¸ í¬ê¸°
        let wordCount = 5; // ê¸°ë³¸ ë‹¨ì–´ ê°œìˆ˜
        let isDragging = false;
        let selectedIndexes = [];
        let selectedWord = "";
        let score = 0;
        let startTime, timerInterval;
        let selectedDirection = { row: 0, col: 0 }; // ë“œë˜ê·¸ ë°©í–¥ ì €ì¥
        
        
        // ê¸°ë¡ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        viewRecordsButton.addEventListener('click', () => {
            recordSection.style.display = 'flex'; // ê¸°ë¡ ì„¹ì…˜ ì—´ê¸°
        });
        // ë‚œì´ë„ ì„¤ì •
        const difficulties = {
          easy: { gridSize: 5, wordCount: 5 },
          medium: { gridSize: 7, wordCount: 7 },
          hard: { gridSize: 9, wordCount: 9 },
        };
        document.addEventListener("DOMContentLoaded", () => {
            const startButton = document.getElementById("startButton");
            startButton.addEventListener("click", generateGame);
        });        
        // ë‚œì´ë„ì— ë”°ë¼ ê·¸ë¦¬ë“œì™€ ë‹¨ì–´ ìƒì„±
        function generateGame() {
          const difficulty = difficultySelect.value;
          gridSize = difficulties[difficulty].gridSize;
          wordCount = difficulties[difficulty].wordCount;
        
          // ë‹¨ì–´ ëª©ë¡ê³¼ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
          wordsToFind = generateWords(wordCount);
          gridWords = generateGridWithWords(gridSize, wordsToFind);
        
          // UI ì´ˆê¸°í™”
          grid.innerHTML = "";
          wordList.innerHTML = "";
          result.textContent = "";
          timerDisplay.textContent = "ê±¸ë¦° ì‹œê°„: 0ì´ˆ";
        
          createGrid();
          createWordList();
        
          // íƒ€ì´ë¨¸ ì‹œì‘
          startTimer();
        }
        
        // ëœë¤í•œ ë‹¨ì–´ ìƒì„±
        function generateWords(count) {
          const sampleWords = ["ê°ë…ì", "í‰ë²”", "í™˜í¬", "ë…ì", "íƒí—˜", "êµ¬ì¡°", "ì†Œë§", "í™”í•™", "ì •ì§"];
          return sampleWords.slice(0, count);
        }
        
        // ì°¾ì„ ë‹¨ì–´ë¥¼ í¬í•¨í•œ ê·¸ë¦¬ë“œ ìƒì„±
        function generateGridWithWords(size, words) {
          const grid = Array.from({ length: size }, () =>
            Array.from({ length: size }, () => "")
          );
        
          words.forEach((word) => {
            let placed = false;
        
            while (!placed) {
              const direction = getRandomDirection();
              const startRow = Math.floor(Math.random() * size);
              const startCol = Math.floor(Math.random() * size);
        
              if (canPlaceWord(grid, word, startRow, startCol, direction)) {
                placeWord(grid, word, startRow, startCol, direction);
                placed = true;
              }
            }
          });
        
          // ë‚˜ë¨¸ì§€ ë¹ˆ ê³µê°„ì„ ëœë¤ ë¬¸ìë¡œ ì±„ì›€
          const letters = "ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬ì•„ìì°¨ì¹´íƒ€íŒŒí•˜";
          for (let row = 0; row < size; row++) {
            for (let col = 0; col < size; col++) {
              if (grid[row][col] === "") {
                grid[row][col] = letters.charAt(Math.floor(Math.random() * letters.length));
              }
            }
          }
        
          // 1ì°¨ì› ë°°ì—´ë¡œ ë³€í™˜
          return grid.flat();
        }
        
        // ëœë¤ ë°©í–¥ ì„ íƒ
        function getRandomDirection() {
          const directions = ["horizontal", "vertical", "diagonal"];
          return directions[Math.floor(Math.random() * directions.length)];
        }
        
        // ë‹¨ì–´ë¥¼ ë°°ì¹˜í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
        function canPlaceWord(grid, word, row, col, direction) {
          const size = grid.length;
          const wordLength = word.length;
        
          if (direction === "horizontal" && col + wordLength > size) return false;
          if (direction === "vertical" && row + wordLength > size) return false;
          if (direction === "diagonal" && (col + wordLength > size || row + wordLength > size)) return false;
        
          for (let i = 0; i < wordLength; i++) {
            const newRow = direction === "vertical" || direction === "diagonal" ? row + i : row;
            const newCol = direction === "horizontal" || direction === "diagonal" ? col + i : col;
        
            if (grid[newRow][newCol] !== "" && grid[newRow][newCol] !== word[i]) return false;
          }
        
          return true;
        }
        
        // ë‹¨ì–´ë¥¼ ê·¸ë¦¬ë“œì— ë°°ì¹˜
        function placeWord(grid, word, row, col, direction) {
          for (let i = 0; i < word.length; i++) {
            const newRow = direction === "vertical" || direction === "diagonal" ? row + i : row;
            const newCol = direction === "horizontal" || direction === "diagonal" ? col + i : col;
            grid[newRow][newCol] = word[i];
          }
        }
        
        // ê·¸ë¦¬ë“œ ìƒì„±
        function createGrid() {
          grid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
          gridWords.forEach((letter, index) => {
            const cell = document.createElement("div");
            cell.textContent = letter;
            cell.dataset.index = index;
            cell.classList.add("grid-item"); // ì…€ì— í´ë˜ìŠ¤ ì¶”ê°€
        
            // í¬ì¸í„° ì´ë²¤íŠ¸ (ë§ˆìš°ìŠ¤ì™€ í„°ì¹˜ ëª¨ë‘ ì²˜ë¦¬)
            cell.addEventListener("pointerdown", (e) => {
              console.log("pointerdown", index); // ë””ë²„ê¹…ìš©
              e.preventDefault(); // ê¸°ë³¸ í¬ì¸í„° ë™ì‘ ë°©ì§€
              startDragging(index, cell);
            });
        
            cell.addEventListener("pointermove", (e) => {
              if (!isDragging) return;
              console.log("pointermove", index); // ë””ë²„ê¹…ìš©
        
              const pointerX = e.clientX;
              const pointerY = e.clientY;
              const target = document.elementFromPoint(pointerX, pointerY);
        
              if (target && target.classList.contains("grid-item")) {
                const targetIndex = parseInt(target.dataset.index, 10);
                if (!selectedIndexes.includes(targetIndex) && isValidMove(selectedIndexes[selectedIndexes.length - 1], targetIndex)) {
                  dragOver(targetIndex, target);
                }
              }
            });
        
            cell.addEventListener("pointerup", () => {
              console.log("pointerup"); // ë””ë²„ê¹…ìš©
              stopDragging();
            });
        
            grid.appendChild(cell);
          });
        
          // í¬ì¸í„°ê°€ ê·¸ë¦¬ë“œ ë°–ìœ¼ë¡œ ë‚˜ê°”ì„ ë•Œë„ ë“œë˜ê·¸ ì¢…ë£Œ
          grid.addEventListener("pointerleave", () => {
            if (isDragging) {
              stopDragging();
            }
          });
        }
        
        // ë‹¨ì–´ ëª©ë¡ ìƒì„±
        function createWordList() {
          wordsToFind.forEach((word) => {
            const li = document.createElement("li");
            li.textContent = word;
            li.dataset.word = word;
            wordList.appendChild(li);
          });
        }
        
        // ë“œë˜ê·¸ ì‹œì‘ (í¬ì¸í„°ìš©)
        function startDragging(index, cell) {
          isDragging = true;
          selectedIndexes = [index];
          selectedWord = gridWords[index];
          cell.classList.add("selected");
        }
        
        // ë“œë˜ê·¸ ì¤‘ (í¬ì¸í„°ìš©)
        function dragOver(index, cell) {
          selectedIndexes.push(index);
          selectedWord += gridWords[index];
          cell.classList.add("selected");
        }
        
        // ë“œë˜ê·¸ ì¢…ë£Œ (í¬ì¸í„°ìš©)
        function stopDragging() {
          if (!isDragging) return;
          isDragging = false;
          checkWord();
          resetSelection();
        }
        
        // ìœ íš¨í•œ ì´ë™ì¸ì§€ í™•ì¸ (í¬ì¸í„°ìš©)
        function isValidMove(lastIndex, currentIndex) {
          const lastRow = Math.floor(lastIndex / gridSize);
          const lastCol = lastIndex % gridSize;
          const currentRow = Math.floor(currentIndex / gridSize);
          const currentCol = currentIndex % gridSize;
        
          // í˜„ì¬ ì„ íƒëœ ë°©í–¥ì´ ì—†ë‹¤ë©´ ì²« ë²ˆì§¸ ì´ë™ì—ì„œ ë°©í–¥ ê²°ì •
          if (selectedIndexes.length === 1) {
            const rowDiff = currentRow - lastRow;
            const colDiff = currentCol - lastCol;
        
            if (Math.abs(rowDiff) <= 1 && Math.abs(colDiff) <= 1) {
              // ê°€ë¡œ, ì„¸ë¡œ, ëŒ€ê°ì„  ë°©í–¥ì¸ì§€ í™•ì¸
              if (rowDiff === 0 || colDiff === 0 || Math.abs(rowDiff) === Math.abs(colDiff)) {
                selectedDirection = { row: rowDiff, col: colDiff }; // ë°©í–¥ ì €ì¥
                return true;
              }
            }
            return false;
          }
        
          // ì´í›„ ì´ë™ì—ì„œëŠ” ì €ì¥ëœ ë°©í–¥ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
          const prevDirection = selectedDirection;
          const rowDiff = currentRow - Math.floor(lastIndex / gridSize);
          const colDiff = currentCol - (lastIndex % gridSize);
        
          return (
            rowDiff === prevDirection.row &&
            colDiff === prevDirection.col
          );
        }
        
        // ë‹¨ì–´ í™•ì¸
        function checkWord() {
          const wordIndex = wordsToFind.indexOf(selectedWord);
          if (wordIndex !== -1) {
            result.textContent = `ì •ë‹µ! ${selectedWord}`;
            result.style.color = "green";
        
            const foundWord = document.querySelector(`li[data-word="${selectedWord}"]`);
            foundWord.classList.add("found");
            wordsToFind.splice(wordIndex, 1);
        
            // ì„ íƒëœ ì…€ í•˜ì´ë¼ì´íŠ¸
            selectedIndexes.forEach(i => {
              const selectedCell = document.querySelector(`.grid div[data-index="${i}"]`);
              selectedCell.classList.add("found");
            });
        
            if (wordsToFind.length === 0) {
              clearInterval(timerInterval);
              result.textContent += " ëª¨ë“  ë‹¨ì–´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!";
              showRecordSection();
            }
          } else {
            result.textContent = "ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”!";
            result.style.color = "red";
          }
        }
        
        // ì„ íƒ ì´ˆê¸°í™”
        function resetSelection() {
          selectedIndexes = [];
          selectedWord = "";
          selectedDirection = { row: 0, col: 0 };
          document.querySelectorAll(".grid div").forEach((cell) => {
            cell.classList.remove("selected");
          });
        }
        
        // íƒ€ì´ë¨¸ ì‹œì‘
        function startTimer() {
          startTime = Date.now();
          clearInterval(timerInterval);
          timerInterval = setInterval(() => {
            const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            timerDisplay.textContent = `ê±¸ë¦° ì‹œê°„: ${elapsedTime}ì´ˆ`;
          }, 1000);
        }
                
        
        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ ë° ê¸°ë¡ ì„¹ì…˜ ì—´ê¸°
                function showRecordSection() {
                    recordSection.style.display = 'flex'; // ëª¨ë‹¬ í‘œì‹œ
                }
        
                // ê¸°ë¡ ì €ì¥ í•¨ìˆ˜ (Firestoreì— ì €ì¥)
                function saveRecord(record) {
                    return db.collection('gameRecords').add(record)
                        .then(() => {
                            console.log('ê²Œì„ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        })
                        .catch((error) => {
                            console.error('ê²Œì„ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ', error);
                            throw error; // ì—ëŸ¬ë¥¼ ìƒìœ„ë¡œ ì „ë‹¬
                        });
                }
        
                // ê¸°ë¡ ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
                saveRecordButton.addEventListener('click', () => {
                    const playerName = document.getElementById('playerName').value.trim();
                    if (!playerName) {
                        alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
                        return;
                    }
        
                    // ê¸°ë¡ ìƒì„±
                    const newRecord = {
                        difficulty: difficultySelect.value,
                        name: playerName,
                        score: score,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp() // ê¸°ë¡ ì‹œê°„
                    };
        
                    // Firestoreì— ê¸°ë¡ ì €ì¥
                    saveRecord(newRecord).then(() => {
                        // ì´ë¦„ ì…ë ¥ í•„ë“œ ìˆ¨ê¸°ê³  ê¸°ë¡ í…Œì´ë¸” í‘œì‹œ
                        document.getElementById('playerName').style.display = 'none';
                        saveRecordButton.style.display = 'none';
                    }).catch((error) => {
                        console.error('ê²Œì„ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ', error);
                        alert('ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    });
                });
                function startMatchingGame() {
                    console.log("startMatchingGame");
                    // Implement game initialization
                    generateGame();
                }        
                // ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
                backToGameButton.addEventListener('click', () => {
                    recordSection.style.display = 'none';
                    // ì´ë¦„ ì…ë ¥ í•„ë“œì™€ ì €ì¥ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê²Œ ì„¤ì •
                    document.getElementById('playerName').style.display = 'block';
                    saveRecordButton.style.display = 'block';
                    // ê²Œì„ ì´ˆê¸°í™”
                    startMatchingGame(); // ìƒˆ ê²Œì„ ì‹œì‘
                });      
                // Firestoreì—ì„œ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                function loadRecordsFromFirestore() {
                    db.collection('gameRecords').orderBy('score', 'desc').onSnapshot((snapshot) => { // ì ìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added') {
                                const record = change.doc.data();
                                addRecordToTable(record);
                            }
                        });
                    });
                }
        
                // ê¸°ë¡ í…Œì´ë¸”ì— ê¸°ë¡ ì¶”ê°€ í•¨ìˆ˜
                function addRecordToTable(record) {
                    const recordTableBody = document.getElementById('recordTable').querySelector('tbody');
                    const row = document.createElement('tr');
                    const date = record.timestamp ? record.timestamp.toDate().toLocaleString() : 'N/A';
                    row.innerHTML = `
                        <td>${record.difficulty}</td>
                        <td>${record.name}</td>
                        <td>${record.score}</td>
                        <td>${date}</td>
                    `;
                    recordTableBody.appendChild(row);
        
                    // í…Œì´ë¸” ëìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
                    recordTableBody.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
        
                // í˜ì´ì§€ ë¡œë“œ ì‹œ Firestore ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                window.onload = async function() {
                    loadRecordsFromFirestore();
                    // initializeMatchingGame(); // ì´ ì¤„ì„ ì œê±°í•˜ê±°ë‚˜ ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”.
                };
        // ê²Œì„ ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸
        startButton.addEventListener("click", generateGame);
        
        // ì´ˆê¸° ê²Œì„ ìƒì„±
        generateGame();
    </script>
</body>
</html>

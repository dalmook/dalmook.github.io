<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logic Game</title>
    <link rel="stylesheet" href="logicgamestyles.css">
    <!-- Firebase SDK 추가 -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>Logic Game</h1>
    
    <!-- 난이도 선택 추가 -->
    <p>난이도를 선택하세요:</p>
    <select id="difficultySelect">
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
    </select>
    
    <p>아래 시퀀스에서 '?'에 들어갈 숫자를 입력하세요:</p>
    <div id="sequence" class="sequence">2 4 ? 8 10</div>
    <input type="number" id="answerInput" placeholder="숫자를 입력하세요">
    <button id="submitAnswerButton">제출</button>
    <p id="result"></p>
    <p id="score">점수: 0</p>
    <p id="timer">걸린 시간: 0초</p>
    
    <button id="saveRecordButton">기록 저장</button>
    <button id="viewRecordsButton">기록 보기</button>

    <!-- 기록 보기 섹션 (숨김 상태) -->
    <div id="recordSection" style="display: none;">
        <h2>게임 기록</h2>
        <table id="recordTable">
            <thead>
                <tr>
                    <th>순위</th>
                    <th>난이도</th>
                    <th>이름</th>
                    <th>점수</th>
                    <th>시간</th>
                    <th>날짜</th>
                </tr>
            </thead>
            <tbody>
                <!-- 기록이 여기에 추가됩니다 -->
            </tbody>
        </table>
        <button id="closeRecordsButton">닫기</button>
    </div>

    <!-- 오버레이 및 이름 입력 폼 (숨김 상태) -->
    <div id="overlay" style="display: none;"></div>
    <div id="name-form" style="display: none;">
        <h2>게임 완료!</h2>
        <p>이름을 입력하세요:</p>
        <input type="text" id="playerName" placeholder="이름">
        <button id="saveNameButton">제출</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCM5kmJDA9zeBg3zmutWk2urV1g3GDHMjw",
            authDomain: "logicgamedalbong.firebaseapp.com",
            projectId: "logicgamedalbong",
            storageBucket: "logicgamedalbong.firebasestorage.app",
            messagingSenderId: "185772514625",
            appId: "1:185772514625:web:a8b9c944e7cdea588255c0"
        };
            // Firebase 초기화
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

// logicgamelogic.js

// Firebase 초기화는 logicgamefirebaseConfig.js에서 이미 완료되었습니다.
// db 변수는 firebase.firestore()로 초기화됨

// DOM 요소 선택
const sequenceElement = document.getElementById("sequence");
const answerInput = document.getElementById("answerInput");
const submitAnswerButton = document.getElementById("submitAnswerButton");
const resultElement = document.getElementById("result");
const scoreElement = document.getElementById("score");
const timerDisplay = document.getElementById("timer");
const saveRecordButton = document.getElementById("saveRecordButton");
const viewRecordsButton = document.getElementById("viewRecordsButton");
const recordSection = document.getElementById("recordSection");
const recordTableBody = document.getElementById("recordTable").querySelector("tbody");
const closeRecordsButton = document.getElementById("closeRecordsButton");
const overlay = document.getElementById("overlay");
const nameForm = document.getElementById("name-form");
const playerNameInput = document.getElementById("playerName");
const saveNameButton = document.getElementById("saveNameButton");
const difficultySelect = document.getElementById("difficultySelect"); // 난이도 선택 요소

// 게임 변수 초기화
let currentQuestion = null;
let score = 0;
let startTime, timerInterval;
let questionsData = {
    easy: [],
    medium: [],
    hard: []
};
let selectedQuestions = {
    easy: [],
    medium: [],
    hard: []
};

// 난이도 선택 이벤트 리스너
difficultySelect.addEventListener("change", () => {
    const difficulty = difficultySelect.value;
    console.log("선택된 난이도:", difficulty);
    generateGame(); // 난이도가 변경되면 게임을 재생성
});

// 게임 생성 함수
function generateGame() {
    resetGame();
    loadQuestions()
        .then(() => {
            selectRandomQuestions(); // 각 난이도별로 5문제 랜덤 선택
            selectRandomQuestion();
            displaySequence();
            startTimer();
        })
        .catch((error) => {
            console.error("질문 로드 실패:", error);
            alert("게임을 시작할 수 없습니다. 나중에 다시 시도해주세요.");
        });
}

// 게임 초기화 함수
function resetGame() {
    currentQuestion = null;
    answerInput.value = "";
    resultElement.textContent = "";
    score = 0;
    scoreElement.textContent = `점수: ${score}`;
    clearInterval(timerInterval);
    timerDisplay.textContent = "걸린 시간: 0초";
}

// JSON 파일에서 질문 로드 함수
async function loadQuestions() {
    if (questionsData.easy.length > 0 || questionsData.medium.length > 0 || questionsData.hard.length > 0) {
        // 이미 로드된 경우 다시 로드하지 않음
        return;
    }
    try {
        const response = await fetch('questions.json');
        if (!response.ok) {
            throw new Error('JSON 파일을 불러오는 데 실패했습니다.');
        }
        const data = await response.json();
        questionsData = data;
        console.log("질문 데이터 로드됨:", questionsData);
    } catch (error) {
        console.error("질문 로드 오류:", error);
        throw error;
    }
}

// 랜덤으로 각 난이도별 5문제 선택 함수
function selectRandomQuestions() {
    const difficulties = ["easy", "medium", "hard"];
    difficulties.forEach((difficulty) => {
        const questions = questionsData[difficulty];
        if (!questions || questions.length === 0) {
            console.warn(`난이도 ${difficulty}에 질문이 없습니다.`);
            selectedQuestions[difficulty] = [];
            return;
        }
        if (questions.length <= 5) {
            selectedQuestions[difficulty] = [...questions]; // 질문이 5개 이하인 경우 모두 사용
        } else {
            selectedQuestions[difficulty] = getRandomSubset(questions, 5);
        }
    });
    console.log("선택된 질문들:", selectedQuestions);
}

// 주어진 배열에서 랜덤하게 'count'개의 요소를 선택하는 유틸리티 함수
function getRandomSubset(array, count) {
    const shuffled = array.sort(() => 0.5 - Math.random());
    return shuffled.slice(0, count);
}

// 난이도에 따른 랜덤 질문 선택 함수
function selectRandomQuestion() {
    const difficulty = difficultySelect.value;
    const questions = selectedQuestions[difficulty];
    if (!questions || questions.length === 0) {
        alert(`모든 질문을 완료했습니다! 게임을 종료합니다.`);
        // recordSection.style.display = "none"; // 기록 섹션 숨기기
        showNameForm();
        return;
    }
    const randomIndex = Math.floor(Math.random() * questions.length);
    currentQuestion = questions[randomIndex];
    console.log("선택된 질문:", currentQuestion);
    
    // 선택된 질문을 목록에서 제거하여 중복 출제를 방지 (선택 사항)
    // selectedQuestions[difficulty].splice(randomIndex, 1);
}

// 시퀀스 표시 함수
function displaySequence() {
    if (!currentQuestion) return;
    sequenceElement.textContent = currentQuestion.sequence;
}

// 정답 제출 함수
submitAnswerButton.addEventListener("click", () => {
    if (!currentQuestion) {
        alert("문제가 로드되지 않았습니다.");
        return;
    }
    const userAnswer = parseFloat(answerInput.value);
    if (isNaN(userAnswer)) {
        alert("숫자를 입력하세요!");
        return;
    }

    if (userAnswer === currentQuestion.answer) {
        resultElement.textContent = "정답입니다!";
        resultElement.style.color = "green";
        resultElement.classList.add("correct");
        resultElement.classList.remove("incorrect");
        score += 10; // 정답 시 점수 증가
    } else {
        resultElement.textContent = `오답입니다! 정답은 ${currentQuestion.answer}입니다. 설명: ${currentQuestion.description}`;
        resultElement.style.color = "red";
        resultElement.classList.add("incorrect");
        resultElement.classList.remove("correct");
    }

    scoreElement.textContent = `점수: ${score}`;
    selectNewQuestion();
});

// 새로운 질문 선택 및 게임 진행 함수
function selectNewQuestion() {
    selectRandomQuestion();
    if (currentQuestion) {
        displaySequence();
        answerInput.value = "";
    }
}

// 타이머 시작 함수
function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(() => {
        const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
        timerDisplay.textContent = `걸린 시간: ${elapsedTime}초`;
    }, 1000);
}

        
// 성공 메시지 표시 및 기록 섹션 열기
function showRecordSection() {
    recordSection.style.display = 'flex'; // 모달 표시
}

// 기록 저장 함수 (Firestore에 저장)
function saveRecord(record) {
    return db.collection('gameRecords').add(record)
        .then(() => {
            console.log('게임 기록이 성공적으로 저장되었습니다.');
        })
        .catch((error) => {
            console.error('게임 기록 저장 중 오류 발생: ', error);
            throw error; // 에러를 상위로 전달
        });
}

// 기록 저장 버튼 이벤트
saveRecordButton.addEventListener('click', () => {
    const playerName = playerNameInput.value.trim();
    if (!playerName) {
        alert('이름을 입력하세요!');
        return;
    }

    // 타이머에서 초 단위 추출
    const elapsedTime = elapsedTimeMatch ? parseInt(elapsedTimeMatch[1], 10) : 0;

    // 기록 생성
    const newRecord = {
      difficulty: difficultySelect.value, // 난이도
      name: playerName,                   // 플레이어 이름
      score: score,                       // 점수
      time: elapsedTime,                  // 걸린 시간
      timestamp: firebase.firestore.FieldValue.serverTimestamp() // 기록 시간
    }
    // Firestore에 기록 저장
    saveRecord(newRecord).then(() => {
        // 이름 입력 필드 숨기고 기록 테이블 표시
        playerNameInput.style.display = 'none';
        saveRecordButton.style.display = 'none';
    }).catch((error) => {
        console.error('게임 기록 저장 중 오류 발생: ', error);
        alert('기록 저장에 실패했습니다. 다시 시도해주세요.');
    });
})
// 게임으로 돌아가기 버튼 이벤트
backToGameButton.addEventListener('click', () => {
    recordSection.style.display = 'none';
    // 이름 입력 필드와 저장 버튼 다시 보이게 설정
    playerNameInput.style.display = 'block';
    saveRecordButton.style.display = 'block';
    // 게임 초기화
    generateGame(); // 수정된 함수 호출
});

// Firestore에서 기록 불러오기
function loadRecordsFromFirestore() {
    db.collection('gameRecords').orderBy('score', 'asc').onSnapshot((snapshot) => { // 점수 기준 내림차순
        snapshot.docChanges().forEach((change) => {
            if (change.type === 'added') {
                const record = change.doc.data();
                addRecordToTable(record);
            }
        });
    });
}

// 기록 테이블에 기록 추가 함수
function addRecordToTable(record) {
    const recordTableBody = document.getElementById('recordTable').querySelector('tbody');
    const row = document.createElement('tr');
    const date = record.timestamp ? record.timestamp.toDate().toLocaleString() : 'N/A';
    row.innerHTML = `
        <td>${record.difficulty}</td>
        <td>${record.name}</td>
        <td>${record.score}</td>
        <td>${date}</td>
    `;
    recordTableBody.appendChild(row)
    // 테이블 끝으로 스크롤 이동
    recordTableBody.scrollIntoView({ behavior: 'smooth', block: 'end' });
}

// 이름 입력 폼 표시 함수
function showNameForm() {
    overlay.style.display = "block";
    nameForm.style.display = "block";
}

// 이름 입력 폼 숨기기 함수
function hideNameForm() {
    overlay.style.display = "none";
    nameForm.style.display = "none";
    playerNameInput.value = "";
}

// 페이지 로드 시 게임 시작
window.onload = () => {
    loadRecordsFromFirestore();
    generateGame();
};
</script>

</body>
</html>
